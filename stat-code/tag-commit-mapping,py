import redis
import rq
import os
import subprocess
from os import path

redis_con = redis.Redis()


def main():
    queue = rq.Queue(name='git-vulns', connection=redis_con)
    DIR = "/mnt/drive/actions-repos"
    dbs = os.listdir(DIR)
    for db in dbs:
        dirpath = f'{DIR}/{db}'

        if path.isdir(dirpath):
            queue.enqueue(worker, job_id=db, kwargs={'dir': dirpath})
            print('enqueued: ', db)


def worker(data):

    return subprocess.check_call(['git-vuln-finder', '-r', data.dir, '-t','-odir', '/mnt/drive/git-vulns'])